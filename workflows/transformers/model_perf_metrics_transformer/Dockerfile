FROM public.ecr.aws/lambda/python:3.10
COPY --from=piplock /Pipfile.lock ${LAMBDA_TASK_ROOT}
COPY . ${LAMBDA_TASK_ROOT}

ARG BUCKET_NAME
ENV BUCKET_NAME=$BUCKET_NAME
ARG MODEL_PERF_METRICS_DESTINATION_PREFIX
ENV MODEL_PERF_METRICS_DESTINATION_PREFIX=$MODEL_PERF_METRICS_DESTINATION_PREFIX

ARG DB_CONNECTION_STRING
ENV DB_CONNECTION_STRING=$DB_CONNECTION_STRING
ARG DB_NAME
ENV DB_NAME=$DB_NAME
ARG MODEL_PERF_METRICS_COLLECTION_NAME
ENV MODEL_PERF_METRICS_COLLECTION_NAME=$MODEL_PERF_METRICS_COLLECTION_NAME

RUN pip install pipenv
RUN pipenv requirements > requirements.txt
RUN pip install -r requirements.txt --target "${LAMBDA_TASK_ROOT}"
CMD [ "lambda_function.lambda_handler" ]`
